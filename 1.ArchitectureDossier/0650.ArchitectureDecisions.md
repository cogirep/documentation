## AD-050 : Mise en place d'une stratégie "multi-entités clientes" (Multitenancy)

### Décision d'architecture
|Identifiant|Décision d'architecture|Domaine|Date|Comité|
|---|---|---|---|---|
|**AD-050**|Isolation complète des tenants. Alternative 03 |**2018-06-21**||


### Enjeux

La conception de la plateforme LOT05-Hyperviseur porte l'ambition d'implémenter un "produit" (cf. Glossaire)
A ce titre, elle doit pouvoir accueillir différentes entités clientes (appelées par la suite « tenant ») au sein d’une même plateforme dans le cadre de leurs activités.

On définira la "multitenancy" ou approche "multi-entité" comme la capacité à délivrer une solution à différentes organisations depuis une instanciation unique d’un logiciel

L'enjeu principal est alors de balancer les avantages et les inconvénients entre deux dimensions antagonistes : La **densité** et l'**isolation**

- La **densité** : Elle correspond au nombre de systèmes et services qui peut être délivré pour un jeu de machine et de logiciel. Plus les ressources sont partagées, plus forte est la densité
- L'**isolation** : Elle correspond aux mécanismes empêchant un tenant (entité utilisatrice de la solution) à affecter l’activité et les données des autres tenants de la même plateforme.

On veillera en particulier à cette isolation pour les différents états de la donnée:

 - **Donnée au repos** / Data at rest, par exemple lors de sa résidence dans une base de données
 - **Données en transit** / Data in transit, par exemple lors de son acheminement vers le navigateur de l'utilisateur
 - **Données en usage** / Data in use, par exemple lorsqu'elle est stockée dans les mémoires 'cache' des serveurs

La complexité de la « multitenancy » est d’effectuer l’arbitrage entre densité et isolation au bon niveau afin de permettre le bon compromis entre risque de pollution entre les clients et la facilité de la maintenance d’un parc de solutions déployées.

Au-delà des considérations sur l’hébergement, on perçoit que la notion de ‘produit’ est capitale. En effet, plus les fonctions/données seront communes entre les différents tenants, plus ils pourront partager une même plateforme.

La « multitenancy » est donc une considération à analyser à différents niveaux :

-	Des machines/IAAS
-	Des systèmes d’exploitation : CAAS/VM,
-	Des briques constitutives de la solution : PAAS
-	de l’implémentation faite : SAAS.


![Multitenancy](./images/produit/001.Multitenancy.png)

### Hypothèses

Par esprit de simplification, une plateforme est découpée en 4 couches

 ![Multitenancy](./images/produit/002.Multitenancy.png)

 -	**MACHINE** : Correspond à l’ensemble de l’infrastructure nécessaire à opérer la solution. Par extension au modèle « Cloud », elle correspond aussi aux machines virtuelles ainsi qu’aux conteneurs logiciels
 -	**DONNEES** : Correspond aux mécanismes de stockage des données. Cela peut être une base de données (relationnelles ou pas), ainsi que les systèmes de fichiers.
 -	**SERVEUR APPLICATION** : COTS, Solution logicielle du marché permettant d’implémenter la plateforme : Serveur JEE, Serveur Node JS. Par extension, l’ensemble des composants « Middleware » : Bus de service, Passerelle de données
 -	**APPLICATION** : Correspond au code applicatif implémentant la solution logicielle
 - Enfin chaque entité client ou "tenant" est idéntifiée par une couleur

Par volonté de limiter les combinatoires, seules 3 approches, les plus représentatives dans le contexte VINCI Autoroutes, sont considérées dans cette décision

### Applicabilité à VINCI Autoroutes.

- Le groupe VINCI Autoroutes est considéré comme le tenant du SYSTEME. Sous cette hypothèse, les autres tenants seraient d'autres groupes, sans rapport avec VINCI Autoroutes.
- Les Sociétés Concessionnaires d'Autoroutes du groupe VINCI Autoroutes **ne sont pas** considérées comme des tenants. Elles sont des sous-entités d'un même tenant : VINCI Autoroutes.
 - La conception du SYSTEME permettra de ségréguer les données des différentes sous-entités d'un tenant.

 ![Multitenancy](./images/produit/003.Multitenancy.png)


### Alternatives
#### Alternative 01 - Partage des machines, COTS, logiciels, code par les tenants
Cette approche consiste à déployer une solution, sur une plateforme entièrement partagée par ses usagers (tenants)

Cette stratégie d’implémentation est parfaitement adaptée pour les services consommés de la même façon par les tenants (Peu de foisonnement).
Par exemple un service de messagerie en ligne, une plateforme de distribution de musique, un site marchand.
Parce que le foisonnement des configurations de la solution entre le client est faible, une très forte densité de tenants peut être atteinte, justifiant de porter l’effort de sécurisation de l’isolation des couches par des moyens logiciels (ségrégation de données au niveau de la base, partitionnement dynamique) ainsi que la gestion des performances (assurer une qualité de service adaptée à chacun des tenants).

D’autres mécanismes de cloisonnement/bonnes pratiques agiles permettent de limiter l’impact d’une montée de version :

-	Partitionnement des fonctions au travers de micro-services indépendants
-	Communauté « early-adopters » sollicitée au moyen d’une approche « Feature Toggle » permettant d’allumer des fonctions nouvelles sur la plateforme à des utilisateurs choisis

**Avantages** :

 - Approche "One size fits all" correspondant bien à une approche "Produit" délivré en SaaS. Permet d'atteindre un très haut niveau d'industrialisation.

**Inconvénients** :

- Complexité des opérations sur la plateforme (Maîtrise du risque et analyse de l'impact continue)

| Critère   | Niveau atteint |
| --------- | :------------: |
| Densité   |    **HAUT**    |
| Isolation | **FAIBLE** (1) |


(1) **FAIBLE** est à interpréter dans le sens "FORTEMENT COMPLEXE". En effet, une isolation complète peut être mise en place mais avec un effort conséquent (d’implémentation mais aussi en opération en marche ‘courante’ afin de prévenir la fuite des données entre tenants)  des solutions logicielles adaptées (Ségrégation dynamique des bases de données par exemple : Mécanisme de type Virtual Private Database)

#### Alternative 02 - Partage des machines. La configuration voire les algorithmes implémentés dans le code applicatif, les données sont cloisonnées à chaque tenant.


Cette approche consiste à isoler complètement chacun des tenants (données, processus) en bénéficiant d'un socle de machine commun.
Cela correspond à une approche de déploiement d'une application pour un tenant donnée dans le Cloud pour un client donné.

Cette stratégie d’implémentation est adaptée pour les plateformes à contextualiser à chacun des tenants.

Cette stratégie est la plus conservatrice. Elle consiste à traiter chaque tenant comme un silo.

L’industrialisation de ce type de plateforme par en grande partie par la capacité à déployer des mécanismes d’intégration continue, et de déploiement continue par des approches DEVOPS.

**Avantages :**

-	Flexibilité, adaptabilité au besoin client
-	Sécurité des données de la solution par un fort cloisonnement


**Inconvénients** :
- A terme , le risque de divergence des futures version de la plateformes entre les tenants est important car ils n'ont plus la contrainte de reposer sur un même socle. Les plateformes peuvent alors diverger si une gouvernance n'est pas mise en place par l'editeur de la solution.
-	Agilité faible (Gestion des versions pour chaque clients)
-	Moins propice à une notion de « Produit » (risque de la spécialisation de la solution)
-	Couts induits par la redondance


| Critère   | Niveau atteint |
| --------- | :------------: |
| Densité   |    **MOYEN**    |
| Isolation | **HAUTE**  |


#### Alternative 03 – Alternative 2 avec isolation des machines

Cette approche est un deploiement de l'alternative 2 avec une isolation des machines pour chacun des clients. Cela pourrait s'assimiler au déploiement de ces solutions sur un Cloud dédié/privé


| Critère   | Niveau atteint |
| --------- | :------------: |
| Densité   |    **FAIBLE**    |
| Isolation | **HAUTE+**  |


### Recommandation

 Alternative 03 – Isolation complète des tenants

### Justification

Bon compromis entre
  - la sécurisation de chaque tenants (mitigation du risque de pollution par les données/activités d'un tenant sur les autres)
  - L'approche "Produit"
  - La confidentialité sur la couche données

### Implications

- Maitrise des processus d'intégration continue et de déploiement continu
- Roles de 'Gestionnaire des versions' à mettre en place (Release Manager)


### Décisions d'architecture liées
|**Identifiant**|**Decision d'architecture**|
|---|---|
|**N/A**|N/A|
